<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"routes_index.js.html":{"id":"routes_index.js.html","title":"Source: routes/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: routes/index.js const { Router } = require('express'); const { query, validationResult } = require('express-validator'); const router = Router(); // Start API // ############################## // Webhook endpoints // ############################## /** * @name /api/twilio/chat/cleanup * @namespace /api/twilio/chat/cleanup * @description Provides an API endpoint for triggering Twilio Chat Cleanup (bypasses schedule) * @global * @param {boolean} cleanRooms - Specifies that chat rooms will be purged * @param {boolean} cleanUsers - Specifies that chat users will be purged * @returns {JSON} responseBody - Success or fail message with relevant details * @author Keith Boice * @see {@link https://zapier.com/blog/what-are-webhooks/|What are Webhooks?} * @example &lt;caption&gt;Example using javascript 'fetch' to trigger the job to purge both Twilio chat rooms and chat users&lt;/caption&gt; * fetch(`/api/twilio/chat/cleanup?cleanRooms=true&amp;cleanUsers=true`) * .then(response =&gt; response.json()) * .then(state =&gt; this.setState(state)); * Returns * { * ResponseBody: success * } */ router.get( '/twilio/chat/cleanup', [query('cleanRooms').isLength({ min: 1 }), query('cleanUsers').isLength({ min: 1 })], (req, res) =&gt; { // Verify that the request contains required parameters. const errors = validationResult(req); if (!errors.isEmpty()) { return res.status(422).json({ status: `failed` }); } // Call our Twilio module for chat cleanup. const Twilio = require('../modules/twilio/index'); console.log(`Running Twilio.CleanupChatRooms`); if (req.query.cleanRooms) { Twilio.CleanupChatRooms() .then((response) =&gt; { res.setHeader('Content-Type', 'application/json'); res.status(200); res.json({ responseBody: response }); }) .catch((error) =&gt; { res.setHeader('Content-Type', 'application/json'); res.status(500); res.json({ status: error }); }); } } ); // Test endpoints // ############################## // We just use this to verify the api endpoints are running at a basic level when monitoring or debugging. router.get('/test', (req, res) =&gt; { res.setHeader('Content-Type', 'application/json'); res.status(200); res.json({ status: `success` }); }); // ############################## // End API module.exports = router; × Search results Close "},"modules_utils_alerts_index.js.html":{"id":"modules_utils_alerts_index.js.html","title":"Source: modules/utils/alerts/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: modules/utils/alerts/index.js const HandleGlobalErrors = require('../errors'); /** * @class * @classdesc Handles sending multi-channel alerts after each successful run and in the case of an error or exception * @member Alerts * @exports ChannelSMS * @returns {Promise} success or fail * @author Keith Boice * @see {@link https://www.twilio.com/docs/sms|Twilio Programmable Messaging SMS} * @example &lt;caption&gt;Send user identity and/or an action to Segment to track&lt;/caption&gt; * Alerts.ChannelSMS( {message: 'Twilio Scheduled Chat Cleanup ran successfully', destination: '+15551234567' } ) * .then((response) =&gt; { * console.log(`Successfully sent SMS to +15551234567`); * }) * .catch((error) =&gt; { * console.error(`Failed to send SMS to +15551234567 with error ${error.stack}`); * }); */ const ChannelSMS = async (req) =&gt; { try { // SMS alert logic goes here. } catch (error) { throw new HandleGlobalErrors(`Alerts.ChannelSMS`, `${error.stack}`).logReport(); } }; module.exports = { ChannelSMS, }; × Search results Close "},"modules_utils_errors_index.js.html":{"id":"modules_utils_errors_index.js.html","title":"Source: modules/utils/errors/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: modules/utils/errors/index.js //const Rollbar = require(\"rollbar\"); //const rollbar = new Rollbar(process.env.ROLLBAR_APP_ID); /** * @class * @classdesc Handles any errors we catch in try/catch block throughout the Node app * @member Errors * @param {string} errorLocation - The class or function in which the error occurred * @param {string} errorDescription - A description of the error that will help with debugging * @exports HandleGlobalErrors * @returns {Promise} Error Log * @author Keith Boice */ class HandleGlobalErrors extends Error { /** * @constructor * @param errorLocation * @param errorDescription */ constructor(errorLocation, errorDescription) { super(); // Maintains proper stack trace for where our error was thrown (only available on V8) if (Error.stack) { this.stackTrace = Error.stack; } if (Error.message) { this.message = Error.message; } // Custom debugging information this.name = 'handleGlobalErrors Triggered'; this.errorLocation = `Location: ${errorLocation}`; this.errorDescription = `Description: ${errorDescription}`; this.date = new Date(); } /** * @method * @returns {string} ErrorDetails */ logReport() { console.error(this.name); console.error(this.errorLocation); console.error(this.errorDescription); console.error(this.date); //rollbar.error(this.errorLocation, this.message); throw new Error( `name: ${this.name}, location: ${this.errorLocation}, stacktrace: ${this.message} - ${this.stackTrace}` ); } } module.exports = HandleGlobalErrors; × Search results Close "},"modules_utils_monitoring_index.js.html":{"id":"modules_utils_monitoring_index.js.html","title":"Source: modules/utils/monitoring/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: modules/utils/monitoring/index.js const HandleGlobalErrors = require('../errors'); /** * @class * @classdesc Handles sending activity to monitoring and logging services * @member Monitoring * @exports SegmentIO * @returns {Promise} success or fail * @author Keith Boice * @see {@link https://segment.com/|Get free SegmentIO account} * @see {@link https://segment.com/docs/connections/sources/catalog/libraries/server/node/quickstart/|SegmentIO NodeJS Quickstart} * @example &lt;caption&gt;Send user identity and/or an action to Segment to track&lt;/caption&gt; * Monitoring.SegmentIO( {userId: 12345, identity: 'keith boice', roomId: 9876, roomName: 'chat room A' } ) * .then((response) =&gt; { * console.log(`Sent to SegmentIO successfully`); * }) * .catch((error) =&gt; { * console.error(`Failed to send to SegmentIO with error ${error.stack}`); * }); */ const SegmentIO = async (req) =&gt; { try { // Instantiate the SegmentIO NodeJS plugin with our SegmentIO write key from .env. const Analytics = require('analytics-node'); const analytics = new Analytics(process.env.MONITORING_SEGMENT_KEY_NODEJS); // Track the Twilio room we just deleted up as an event in SegmentIO. analytics.track({ userId: req.userId, event: req.eventName, properties: { roomId: req.roomId, roomName: req.roomName, } }); } catch (error) { throw new HandleGlobalErrors(`Utils.Monitoring.SegmentIO`, `${error.stack}`).logReport(); } }; module.exports = { SegmentIO, }; × Search results Close "},"modules_utils_populate_index.js.html":{"id":"modules_utils_populate_index.js.html","title":"Source: modules/utils/populate/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: modules/utils/populate/index.js const dotenv = require('dotenv'); const dotenvExpand = require('dotenv-expand'); const myEnv = dotenv.config(); dotenvExpand(myEnv); const HandleGlobalErrors = require('../errors'); /** * @class * @classdesc Handles populating Twilio with a chat room for testing and development purposes * @member Testing * @exports Populate * @author Keith Boice */ const accountSid = process.env.TWILIO_ACCOUNT_SID; const authToken = process.env.TWILIO_AUTH_TOKEN; const chatSid = process.env.TWILIO_CHAT_SERVICE_SID; const client = require('twilio')(accountSid, authToken); client.chat.services(chatSid) .channels .create({ friendlyName: 'test channel A' }) .then((channel) =&gt; console.log(`Created Twilio chat room ${channel.sid}`)) .catch((e) =&gt; console.error(e.stack)); × Search results Close "},"modules_twilio_index.js.html":{"id":"modules_twilio_index.js.html","title":"Source: modules/twilio/index.js","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Source: modules/twilio/index.js const HandleGlobalErrors = require('../utils/errors'); /** * @class * @classdesc Handles deleting old Twilio chat rooms * @member Twilio * @exports CleanupChatRooms * @returns {Promise} success or fail * @author Keith Boice * @see {@link https://www.twilio.com/console/chat/dashboard|Twilio Chat Console} * @see {@link https://www.twilio.com/docs/tutorials?filter-product=Chat&amp;filter-language=Node|Twilio Programmable Chat NodeJS Guide} * @example &lt;caption&gt;Delete all old Twilio Chat Rooms from your account&lt;/caption&gt; * Twilio.CleanupChatRooms() * .then((response) =&gt; { * console.log(`Twilio chat room deleted successfully`); * }) * .catch((error) =&gt; { * console.error(`Failed to delete Twilio chat room with error ${error.stack}`); * }); */ const CleanupChatRooms = async (req) =&gt; { try { // Twilio authentication keys and values are pulled from the .env file in the project root. See .env.sample for example. const twilioAccountSid = process.env.TWILIO_ACCOUNT_SID; //ACCOUNT SID from Twilio Console const twilioChatSService = process.env.TWILIO_CHAT_SERVICE_SID; //Chat Service SID from Twilio Chat Console const twilioAuthToken = process.env.TWILIO_AUTH_TOKEN; //AUTH TOKEN from Twilio Console // Retrieve all chat channels we created since we last checked const client = require('twilio')(twilioAccountSid, twilioAuthToken); client.chat.services(twilioChatSService) .channels .list({ limit: 1000 }) .then(channels =&gt; { channels.forEach(c =&gt; { // Remove each channel one by one client.chat.services(twilioChatSService) .channels(c.sid) .remove(); // Log to SegmentIO if SegmentIO is enabled in .env const Monitoring = require('../utils/monitoring'); Monitoring.SegmentIO( {userId: c.createdBy, eventName: 'Deleted chat channel', roomId: c.sid, roomName: c.friendlyName } ) .then((response) =&gt; { console.log(`Sent to SegmentIO successfully`); }) .catch((error) =&gt; { console.error(`Failed to send to SegmentIO with error ${error.stack}`); }); console.log(`removed - ${c.sid}`); }) }); console.log(`Finished fetching chat channels`); return 'success'; } catch (error) { throw new HandleGlobalErrors(`Twilio.CleanupChatRooms`, `${error.stack}`).logReport(); } }; module.exports = { CleanupChatRooms, }; × Search results Close "},"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Modules Classes HandleGlobalErrors Namespaces /api/twilio/chat/cleanup Provides an API endpoint for triggering Twilio Chat Cleanup (bypasses schedule). × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Classes Classes HandleGlobalErrors Namespaces /api/twilio/chat/cleanup Provides an API endpoint for triggering Twilio Chat Cleanup (bypasses schedule). × Search results Close "},"namespaces.list.html":{"id":"namespaces.list.html","title":"Namespaces","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Namespaces Classes HandleGlobalErrors Namespaces /api/twilio/chat/cleanup Provides an API endpoint for triggering Twilio Chat Cleanup (bypasses schedule). × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Home Welcome to Twilio Scheduled Chat Channel Cleanup project. This is a NodeJS utility script that I created to run common Twilio Chat cleanup functions on a nightly schedule. It does things like delete old chat rooms and chat users to ensure you never hit the limit Twilio places on your account (and just for good hygiene). Features and Functionality Automatically cleans up old Twilio Programmable Chat Rooms and Users from your account on a daily basis Webhook endpoints for triggering cleanup from external events or command line rather than a schedule Granular configuration to turn specific cleanup activities off or on from a single file Multi-channel alerts and notifications upon successful runs and errors/exceptions Monitor and log all activity in popular tools like SegmentIO, New Relic, PM2 and Rollbar Enhanced error handling w/ logging and tracing Jest test coverage and reporting in JSON, text, HTML and markdown CircleCI CI/CD for automating DevOps and deployments Requirements Node.js Version NPM Version CircleCI Docker Repo Database Cloud Platform 12+ 6+ Free Account Any None Any Getting Started Clone the project, and install the dependencies $ git clone https://github.com/kboice23/Twilio-Scheduled-Chat-Channel-Cleanup $ cd Twilio-Scheduled-Chat-Channel-Cleanup $ npm install Configure your environment Update with your own Twilio IDs, Keys and Tokens: and update keys for any monitoring tools you'd like $ mv .env.sample .env $ nano .env # Twilio Cleanup CONFIG_CLEAN_CHAT_ROOMS=true CONFIG_CLEAN_CHAT_USERS= true # Monitoring and Logging CONFIG_TRACK_IN_SEGMENT = true; # Twilio Account TWILIO_ACCOUNT_SID=ACXXXXXXXXXXXXXXXXXXXXXXXXXXXXX TWILIO_AUTH_TOKEN=fdXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX TWILIO_CHAT_SERVICE_SID=ISXXXXXXXXXXXXXXXXXXXXXXXX # Monitoring and Logging Accounts MONITORING_SEGMENT_KEY_NODEJS=XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX Verify all is working by populating some test chat rooms in Twilio $ npm run populate Created Twilio chat room CHf9c7563e5a7942dda6b18d578e5b662e You can double check that the room was created in the Twilio console via a web browser Start the node server Development mode $ npm run dev [nodemon] 2.0.4 [nodemon] to restart at any time, enter `rs` [nodemon] watching path(s): *.* [nodemon] watching extensions: js,mjs,json [nodemon] starting `node index.js` Waiting until 2AM each day to delete all old chat channels [nodemon] restarting due to changes... [nodemon] starting `node index.js` Debug mode $ npm run debug [nodemon] 2.0.4 [nodemon] to restart at any time, enter `rs` [nodemon] watching path(s): *.* [nodemon] watching extensions: js,mjs,json [nodemon] starting `node --inspect index.js` Debugger listening on ws://127.0.0.1:9229/5cbb7824-c467-489f-868a-972892282165 For help, see: https://nodejs.org/en/docs/inspector Waiting until 2AM each day to delete all old chat channels [nodemon] restarting due to changes... [nodemon] starting `node --inspect index.js` Debugger listening on ws://127.0.0.1:9229/e5514ff8-ceae-4e2f-80e7-bcd3bbe6a557 For help, see: https://nodejs.org/en/docs/inspector Waiting until 2AM each day to delete all old chat channels Production mode $ npm run server Waiting until 2AM each day to delete all old chat channels Run the node server with scheduling disabled Tip: good for development and testing Development mode $ npm run devNow [nodemon] 2.0.4 [nodemon] to restart at any time, enter `rs` [nodemon] watching path(s): *.* [nodemon] watching extensions: js,mjs,json Successfully deleted all old chat channels [nodemon] restarting due to changes... Debug mode $ npm run debugNow [nodemon] 2.0.4 [nodemon] to restart at any time, enter `rs` [nodemon] watching path(s): *.* [nodemon] watching extensions: js,mjs,json Debugger listening on ws://127.0.0.1:9229/5cbb7824-c467-489f-868a-972892282165 For help, see: https://nodejs.org/en/docs/inspector Successfully deleted all old chat channels [nodemon] restarting due to changes... Debugger listening on ws://127.0.0.1:9229/e5514ff8-ceae-4e2f-80e7-bcd3bbe6a557 For help, see: https://nodejs.org/en/docs/inspector Successfully deleted all old chat channels Production mode $ npm run serverNow Successfully deleted all old chat channels Run Jest tests $ npm run test Generate documentation using JSDocs $ npm run docs × Search results Close "},"-_api_twilio_chat_cleanup.html":{"id":"-_api_twilio_chat_cleanup.html","title":"Namespace: /api/twilio/chat/cleanup","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Namespace: /api/twilio/chat/cleanup /api/twilio/chat/cleanup Provides an API endpoint for triggering Twilio Chat Cleanup (bypasses schedule) Author: Keith Boice Source: routes/index.js, line 12 See: What are Webhooks? Example Example using javascript 'fetch' to trigger the job to purge both Twilio chat rooms and chat users fetch(`/api/twilio/chat/cleanup?cleanRooms=true&amp;cleanUsers=true`) .then(response =&gt; response.json()) .then(state =&gt; this.setState(state)); Returns { ResponseBody: success } × Search results Close "},"module-Alerts.html":{"id":"module-Alerts.html","title":"Module: Alerts","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Module: Alerts Author: Keith Boice Source: modules/utils/alerts/index.js, line 3 See: Twilio Programmable Messaging SMS Example Send user identity and/or an action to Segment to track Alerts.ChannelSMS( {message: 'Twilio Scheduled Chat Cleanup ran successfully', destination: '+15551234567' } ) .then((response) =&gt; { console.log(`Successfully sent SMS to +15551234567`); }) .catch((error) =&gt; { console.error(`Failed to send SMS to +15551234567 with error ${error.stack}`); }); × Search results Close "},"module-Errors.html":{"id":"module-Errors.html","title":"Module: Errors","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Module: Errors Author: Keith Boice Source: modules/utils/errors/index.js, line 4 Classes HandleGlobalErrors × Search results Close "},"module-Errors-HandleGlobalErrors.html":{"id":"module-Errors-HandleGlobalErrors.html","title":"Class: HandleGlobalErrors","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Class: HandleGlobalErrors Errors~ HandleGlobalErrors new HandleGlobalErrors(errorLocation, errorDescription) Parameters: Name Type Description errorLocation errorDescription Source: modules/utils/errors/index.js, line 20 Methods logReport() → {string} Source: modules/utils/errors/index.js, line 43 Returns: ErrorDetails Type string × Search results Close "},"module-Monitoring.html":{"id":"module-Monitoring.html","title":"Module: Monitoring","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Module: Monitoring Author: Keith Boice Source: modules/utils/monitoring/index.js, line 3 See: Get free SegmentIO account SegmentIO NodeJS Quickstart Example Send user identity and/or an action to Segment to track Monitoring.SegmentIO( {userId: 12345, identity: 'keith boice', roomId: 9876, roomName: 'chat room A' } ) .then((response) =&gt; { console.log(`Sent to SegmentIO successfully`); }) .catch((error) =&gt; { console.error(`Failed to send to SegmentIO with error ${error.stack}`); }); × Search results Close "},"module-Testing.html":{"id":"module-Testing.html","title":"Module: Testing","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Module: Testing Author: Keith Boice Source: modules/utils/populate/index.js, line 9 × Search results Close "},"module-Twilio.html":{"id":"module-Twilio.html","title":"Module: Twilio","body":" Twilio Scheduled Chat Cleanup Namespaces /api/twilio/chat/cleanup Modules AlertsErrorsMonitoringTestingTwilio Classes Errors~HandleGlobalErrors Module: Twilio Author: Keith Boice Source: modules/twilio/index.js, line 3 See: Twilio Chat Console Twilio Programmable Chat NodeJS Guide Example Delete all old Twilio Chat Rooms from your account Twilio.CleanupChatRooms() .then((response) =&gt; { console.log(`Twilio chat room deleted successfully`); }) .catch((error) =&gt; { console.error(`Failed to delete Twilio chat room with error ${error.stack}`); }); × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
